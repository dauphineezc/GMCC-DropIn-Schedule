<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .event-card {
      position: absolute;
      box-sizing: border-box;
      border-left-width: 4px;
      border-radius: 0.5rem;
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }
    #time-indicator {
      position: absolute;
      height: 2px;
      background-color: red;
      z-index: 30;
    }
    #time-indicator-dot {
      position: absolute;
      width: 8px;
      height: 8px;
      background-color: red;
      border-radius: 50%;
      top: -3px;
      left: -4px;
    }
  </style>
</head>
<body class="p-4">

  <!-- Controls -->
  <div class="no-print grid grid-cols-3 items-center gap-3 mb-3">
    <!-- Prev/Today/Next -->
    <div class="flex items-center gap-2">
      <button id="prevBtn" class="px-2 py-1 border rounded">◀</button>
      <button id="todayBtn" class="px-2 py-1 border rounded">Today</button>
      <button id="nextBtn" class="px-2 py-1 border rounded">▶</button>
    </div>
    <!-- Date Range -->
    <div id="rangeLabel" class="font-semibold text-center"></div>
    <!-- Timezone -->
    <div class="text-sm text-gray-500 text-right">
      Times shown in <span id="tzLabel"></span>
    </div>
  </div>

  <!-- Tabs -->
  <div class="flex gap-6 border-b mb-2">
    <button class="tab-btn font-semibold border-b-2 border-blue-500">Aquatics</button>
    <button class="tab-btn">Court Sports</button>
    <button class="tab-btn">Community</button>
  </div>

  <!-- Calendar -->
  <div id="calendarBody" class="relative grid" style="grid-template-columns: 60px repeat(7, 1fr);"></div>

  <script>
    const els = {
      gridBody: document.getElementById('calendarBody'),
      rangeLabel: document.getElementById('rangeLabel'),
      tzLabel: document.getElementById('tzLabel')
    };

    const events = [
      { name: "Lap Swim", start: 5, end: 8, dayIndex: 0, color: "bg-blue-100", textColor: "text-blue-800", borderColor: "border-blue-500" },
      { name: "Rec Swim", start: 5, end: 8, dayIndex: 0, color: "bg-green-100", textColor: "text-green-800", borderColor: "border-green-500" },
      { name: "Water Aerobics", start: 9, end: 10, dayIndex: 1, color: "bg-purple-100", textColor: "text-purple-800", borderColor: "border-purple-500" }
    ];

    function renderGrid() {
      els.gridBody.innerHTML = "";

      const startHour = 5;
      const endHour = 22;
      const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

      // Header row
      els.gridBody.appendChild(document.createElement('div')); // empty top-left
      days.forEach(day => {
        const cell = document.createElement('div');
        cell.className = 'p-2 text-center font-semibold';
        cell.textContent = day;
        els.gridBody.appendChild(cell);
      });

      // Spacer row before first hour
      const spacerTime = document.createElement("div");
      spacerTime.className = "border-r border-gray-200 h-4";
      els.gridBody.appendChild(spacerTime);
      for (let d = 0; d < 7; d++) {
        const spaceCell = document.createElement("div");
        spaceCell.className = "border-r border-b border-gray-200 h-4";
        els.gridBody.appendChild(spaceCell);
      }

      // Hour rows
      for (let hour = startHour; hour <= endHour; hour++) {
        const timeCell = document.createElement('div');
        timeCell.className = 'p-2 border-r border-gray-200 text-right text-xs text-gray-400 h-16 flex items-start justify-end -mt-2.5';
        timeCell.style.gridRow = `${hour - startHour + 3} / span 1`;
        timeCell.textContent = `${hour > 12 ? hour - 12 : hour} ${hour < 12 ? 'AM' : 'PM'}`;
        els.gridBody.appendChild(timeCell);

        for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
          const gridCell = document.createElement('div');
          gridCell.className = 'border-r border-b border-gray-200 h-16 relative';
          els.gridBody.appendChild(gridCell);
        }
      }

      renderGridEvents(events);
      positionTimeIndicator();
    }

    function renderGridEvents(events) {
      const calendarStartHour = 5;
      const rowHeight = 64;
      const layout = {}; 

      events.forEach(event => {
        for (let hour = event.start; hour < event.end; hour++) {
          const key = `${event.dayIndex}_${hour}`;
          if (!layout[key]) layout[key] = [];
          layout[key].push(event);
        }
      });

      events.forEach(event => {
        const eventEl = document.createElement('div');
        eventEl.className = `event-card shadow-sm overflow-hidden ${event.color} ${event.textColor} border-l-4 ${event.borderColor}`;
        
        const startRowIndex = event.start - calendarStartHour;
        const durationInHours = event.end - event.start;
        const col = event.dayIndex + 2;

        eventEl.style.gridColumn = `${col} / span 1`;
        eventEl.style.top = `${(startRowIndex * rowHeight) + 16}px`; // +16 to account for spacer
        eventEl.style.height = `${durationInHours * rowHeight}px`;

        const overlapKey = `${event.dayIndex}_${event.start}`;
        const overlappingEvents = layout[overlapKey] || [];
        const totalOverlaps = overlappingEvents.length;
        const eventIndex = overlappingEvents.findIndex(e => e.name === event.name);

        if (totalOverlaps > 1) {
          const width = 100 / totalOverlaps;
          eventEl.style.width = `calc(${width}% - 8px)`;
          eventEl.style.left = `calc(${eventIndex * width}% + 4px)`;
        } else {
          eventEl.style.width = 'calc(100% - 8px)';
          eventEl.style.left = '4px';
        }

        eventEl.innerHTML = `<p class="font-semibold text-sm">${event.name}</p><p class="text-xs">${formatTime(event.start)} - ${formatTime(event.end)}</p>`;
        els.gridBody.appendChild(eventEl);
      });
    }

    function formatTime(hour) {
      const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
      const ampm = hour < 12 ? 'AM' : 'PM';
      return `${displayHour}:00 ${ampm}`;
    }

    function positionTimeIndicator() {
      let indicator = document.getElementById('time-indicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'time-indicator';
        indicator.innerHTML = '<div id="time-indicator-dot"></div>';
        els.gridBody.appendChild(indicator);
      }
      
      const now = new Date();
      const startHour = 5;
      const endHour = 22;
      const currentHour = now.getHours();
      const currentMinutes = now.getMinutes();

      if (currentHour >= startHour && currentHour < endHour) {
        indicator.style.display = 'block';
        const dayIndex = (now.getDay() + 6) % 7;
        const hoursPastStart = currentHour - startHour;
        const minutesPastStart = (hoursPastStart * 60) + currentMinutes;
        const rowHeight = 64;
        const topPosition = (minutesPastStart / 60) * rowHeight + 16; // account for spacer

        indicator.style.gridColumn = `${dayIndex + 2} / span 1`;
        indicator.style.top = `${topPosition}px`;
      } else {
        indicator.style.display = 'none';
      }
    }

    // Init
    els.tzLabel.textContent = Intl.DateTimeFormat().resolvedOptions().timeZone;
    renderGrid();
    setInterval(positionTimeIndicator, 60000);
  </script>
</body>
</html>
